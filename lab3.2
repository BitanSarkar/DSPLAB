float x[]={-87.17307638,-109.5495333,11.00037444,163.4286511,199.1497693,123.5660003,56.25558579,11.87495703,-18.97729813,-42.98507139,-49.50432452,-44.95819516,-33.93206642,-28.58275615,-31.58109989,-41.0802992,-54.49307368,-68.26273259,-80.63560247,-89.53265601,-97.96825536,-104.8688265,-109.0354357,-55.42792547,102.4289065,215.9352907,173.6592794,95.27713062,38.69934301,2.586699113,-27.11808597,-41.50592056,-38.88116345,-27.52106187,-19.43972127,-21.31888102,-29.19861314,-42.08703327,-57.83191118,-69.53303635,-80.46281953,-88.35226795,-94.97094082,-102.2065852,-97.71319214,4.172319927,174.7275931,221.5697151,147.842936,75.61863429,28.48903346,-4.64088307,-29.76995187,-35.85962812,-27.26819387,-12.26373734,-5.602559446,-9.189517172,-21.48116953,-38.07938735,-52.01784737,-63.35879895,-71.93471855,-79.04261272,-85.4265121,-86.88364206,-9.984335526,167.9810654,251.6113399,182.1367896,108.0062751,59.54909365,24.89964724,-5.472668004,-17.77934267
};
float baseline[75]={0};
float acf[75]={0};
float avg = 0;
float F=25.0;
void autocorr(float y[]);
void smooth(int n, int w);
float mean(int n);
void setup() {
  smooth(75,10);
  avg = mean(75);
  Serial.begin(9600);
}

void loop() {
    autocorr(x);
    int pos = 0;
    for(pos=1;pos<75;pos++){
      if(acf[pos]<=acf[pos-1] && acf[pos]<=acf[pos+1]){
        break;
      }
    }
    float maxx = -100;
    int maxxPos = pos;
    for(int j=pos;j<75;j++){
      if(maxx<acf[j]){
        maxx=acf[j];
        maxxPos=j;
      }
    }
    float pulse_rate = 60*F/((maxxPos+0.0));
    Serial.println(pulse_rate);
    for(int j=0;j<75;j++){
      acf[j]=0.0;
    }
  }

void autocorr(float y[]){
  acf[0]=0.0;
  for(int j=0;j<75;j++){
      acf[0]+=y[j]*y[j];
  }
  for(int d=1;d<75;d++){
    float sum = 0.0;
    for(int j=d;j<75;j++){
      sum+=y[j]*y[j-d];
    }
    acf[d]=sum/acf[0];
  }
  acf[0]=1;
}
void smooth(int n, int w){
  for(int i=0;i<n;i++){
    float avg = 0.0;
    float c = 0.0;
    for(int j=i;j<=i+w && j<n; j++){
      avg+=x[j];
      c++;
    }
    avg/=c;
    x[i] = avg;
  }
}
float mean(int n){
  float avg=0.0;
  for(int i=0;i<n;i++){
    avg+=x[i];
  }
  avg/=(n+0.0);
  return avg;
}
